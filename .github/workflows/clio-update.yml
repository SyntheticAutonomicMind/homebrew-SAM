name: Update Homebrew on Release

on:
  release:
    types: [published]

jobs:
  update-homebrew:
    runs-on: ubuntu-latest
    
    steps:
      - name: Extract version from tag
        id: version
        run: |
          VERSION="${{ github.ref }}"
          VERSION="${VERSION#refs/tags/}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Get release asset URL
        id: asset
        uses: actions/github-script@v7
        with:
          script: |
            const release = await github.rest.repos.getRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
            });
            
            // Find the tar.gz asset
            const asset = release.data.assets.find(a => a.name.endsWith('.tar.gz'));
            if (!asset) {
              throw new Error('No tar.gz asset found in release');
            }
            
            console.log('Asset:', asset.name);
            core.setOutput('url', asset.browser_download_url);

      - name: Call homebrew update workflow
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: 'SyntheticAutonomicMind',
              repo: 'homebrew',
              workflow_id: 'update-formula-on-release.yml',
              ref: 'main',
              inputs: {
                project: 'clio',
                version: '${{ steps.version.outputs.version }}',
                download_url: '${{ steps.asset.outputs.url }}',
              },
            });

      - name: Notify success
        run: |
          echo "[OK] Homebrew update triggered for CLIO ${{ steps.version.outputs.version }}"
