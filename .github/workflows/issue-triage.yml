name: Issue Triage with CLIO

on:
  issues:
    types: [opened, edited, reopened]
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read
  packages: read

env:
  CLIO_MODEL: gpt-5-mini
  REGISTRY: ghcr.io

jobs:
  triage:
    name: Analyze and Triage Issue
    runs-on: ubuntu-latest
    
    if: |
      (github.event_name == 'issues' && github.event.issue.user.type != 'Bot') ||
      (github.event_name == 'issue_comment' && 
       !github.event.issue.pull_request && 
       github.event.comment.user.type != 'Bot' &&
       contains(github.event.issue.labels.*.name, 'needs-info'))
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Pull CLIO container
        run: docker pull ghcr.io/syntheticautonomicmind/clio:latest
      
      - name: Prepare workspace
        run: |
          mkdir -p /tmp/clio-workspace
          cp -r ./* /tmp/clio-workspace/ 2>/dev/null || true
          cp -r ./.clio /tmp/clio-workspace/ 2>/dev/null || true
          cp -r ./.github /tmp/clio-workspace/ 2>/dev/null || true
          mkdir -p /tmp/clio-workspace/.clio/sessions
          mkdir -p /tmp/clio-config
      
      - name: Configure CLIO authentication
        env:
          CLIO_ACCESS: ${{ secrets.CLIO_ACCESS }}
        run: |
          set +x
          printf '{"github_token": "%s", "saved_at": %d}' "$CLIO_ACCESS" "$(date +%s)" > /tmp/clio-config/github_tokens.json
          chmod 600 /tmp/clio-config/github_tokens.json
          echo '{"provider": "github_copilot"}' > /tmp/clio-config/config.json
      
      - name: Prepare issue info files
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_LABELS_JSON: ${{ toJson(github.event.issue.labels) }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          EVENT_NAME: ${{ github.event_name }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Write issue body (safely via env var)
          printf '%s' "$ISSUE_BODY" > /tmp/clio-workspace/ISSUE_BODY.md
          
          # Fetch comments
          gh api "repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments" \
            --jq '.[] | "---\n**\(.user.login)** commented at \(.created_at):\n\(.body)\n"' \
            > /tmp/clio-workspace/ISSUE_COMMENTS.md 2>/dev/null || echo "" > /tmp/clio-workspace/ISSUE_COMMENTS.md
          
          COMMENT_COUNT=$(gh api "repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments" --jq 'length' 2>/dev/null || echo "0")
          
          # Parse labels from env var (safely)
          CURRENT_LABELS=$(echo "$ISSUE_LABELS_JSON" | jq -r '.[].name' 2>/dev/null | paste -sd ',' - || echo "none")
          
          # Create issue info file (using env vars for safety)
          {
            echo "# Issue #${ISSUE_NUMBER}"
            echo ""
            echo "**Title:** ${ISSUE_TITLE}"
            echo "**Author:** ${ISSUE_AUTHOR}"
            echo "**Current Labels:** ${CURRENT_LABELS}"
            echo "**Event:** ${EVENT_NAME} (comments: ${COMMENT_COUNT})"
            echo ""
            echo "## Body"
            echo ""
            echo "See ISSUE_BODY.md"
          } > /tmp/clio-workspace/ISSUE_INFO.md
          
          echo "Issue info prepared"
      
      - name: Run CLIO Issue Triage
        id: triage
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          TASK="You are in HEADLESS CI/CD MODE. No human is present.

          TASK: Triage Issue #${ISSUE_NUMBER}

          STEPS:
          1. Read .github/clio-prompts/issue-triage.md for instructions
          2. Read ISSUE_INFO.md and ISSUE_BODY.md for issue details
          3. Read ISSUE_COMMENTS.md if there are comments
          4. WRITE your triage JSON to /workspace/triage.json using file_operations

          CRITICAL: 
          - DO NOT use user_collaboration (it will hang forever)
          - Write JSON to /workspace/triage.json using file_operations create_file"
          
          echo "=== Starting CLIO Issue Triage ==="
          
          docker run -i --rm \
            -v "/tmp/clio-workspace":/workspace:rw \
            -v "/tmp/clio-config":/root/.clio:rw \
            -w /workspace \
            -e CLIO_LOG_LEVEL=WARNING \
            -e GH_TOKEN="${GH_TOKEN}" \
            ghcr.io/syntheticautonomicmind/clio:latest \
            --new \
            --model "$CLIO_MODEL" \
            --input "$TASK" \
            --exit 2>&1 | tee /tmp/clio-workspace/full_response.txt || true
          
          echo ""
          echo "=== CLIO Triage Complete ==="
          
          if [ -f /tmp/clio-workspace/triage.json ]; then
            echo "triage.json found!"
          else
            echo "triage.json NOT found"
          fi
      
      - name: Get triage JSON
        id: extract
        run: |
          if [ -f /tmp/clio-workspace/triage.json ] && jq . /tmp/clio-workspace/triage.json > /dev/null 2>&1; then
            echo "Using triage.json written by CLIO"
            cp /tmp/clio-workspace/triage.json /tmp/clio-workspace/analysis.json
            echo "json_valid=true" >> $GITHUB_OUTPUT
          else
            echo "json_valid=false" >> $GITHUB_OUTPUT
            echo '{"completeness":50,"classification":"bug","severity":"medium","priority":"medium","recommendation":"ready-for-review","labels":["needs-review"],"assign_to":"fewtarius","summary":"Automated triage could not produce triage.json. Manual review recommended."}' > /tmp/clio-workspace/analysis.json
            echo "Using fallback JSON"
          fi
          
          echo "=== Triage JSON ==="
          cat /tmp/clio-workspace/analysis.json
      
      - name: Parse results
        id: parse
        run: |
          ANALYSIS=$(cat /tmp/clio-workspace/analysis.json)
          
          RECOMMENDATION=$(echo "$ANALYSIS" | jq -r '.recommendation // "ready-for-review"')
          CLASSIFICATION=$(echo "$ANALYSIS" | jq -r '.classification // "bug"')
          PRIORITY=$(echo "$ANALYSIS" | jq -r '.priority // "medium"')
          COMPLETENESS=$(echo "$ANALYSIS" | jq -r '.completeness // 50')
          LABELS=$(echo "$ANALYSIS" | jq -r '(.labels // []) | join(",")')
          ASSIGN_TO=$(echo "$ANALYSIS" | jq -r '.assign_to // ""')
          CLOSE_REASON=$(echo "$ANALYSIS" | jq -r '.close_reason // ""')
          
          echo "recommendation=$RECOMMENDATION" >> $GITHUB_OUTPUT
          echo "classification=$CLASSIFICATION" >> $GITHUB_OUTPUT
          echo "priority=$PRIORITY" >> $GITHUB_OUTPUT
          echo "completeness=$COMPLETENESS" >> $GITHUB_OUTPUT
          echo "labels=$LABELS" >> $GITHUB_OUTPUT
          echo "assign_to=$ASSIGN_TO" >> $GITHUB_OUTPUT
          echo "close_reason=$CLOSE_REASON" >> $GITHUB_OUTPUT
      
      - name: Apply labels
        if: steps.parse.outputs.labels != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          RECOMMENDATION: ${{ steps.parse.outputs.recommendation }}
        run: |
          # Remove old priority labels if we're setting a new one
          gh issue edit "$ISSUE_NUMBER" --remove-label "priority:critical" 2>/dev/null || true
          gh issue edit "$ISSUE_NUMBER" --remove-label "priority:high" 2>/dev/null || true
          gh issue edit "$ISSUE_NUMBER" --remove-label "priority:medium" 2>/dev/null || true
          gh issue edit "$ISSUE_NUMBER" --remove-label "priority:low" 2>/dev/null || true
          
          # Remove needs-info if issue is now complete
          if [ "$RECOMMENDATION" != "needs-info" ]; then
            gh issue edit "$ISSUE_NUMBER" --remove-label "needs-info" 2>/dev/null || true
          fi
          
          # Add new labels
          IFS=',' read -ra LABELS <<< "${{ steps.parse.outputs.labels }}"
          for label in "${LABELS[@]}"; do
            label=$(echo "$label" | xargs)
            if [ -n "$label" ]; then
              gh issue edit "$ISSUE_NUMBER" --add-label "$label" 2>/dev/null || \
              (gh label create "$label" --color "c5def5" 2>/dev/null; gh issue edit "$ISSUE_NUMBER" --add-label "$label" 2>/dev/null) || true
            fi
          done
      
      - name: Assign issue
        if: steps.parse.outputs.assign_to != '' && steps.parse.outputs.recommendation != 'close'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ASSIGN_TO: ${{ steps.parse.outputs.assign_to }}
        run: |
          gh issue edit "$ISSUE_NUMBER" --add-assignee "$ASSIGN_TO" 2>/dev/null || true
      
      - name: Handle close recommendation
        if: steps.parse.outputs.recommendation == 'close'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          CLOSE_REASON: ${{ steps.parse.outputs.close_reason }}
        run: |
          ANALYSIS=$(cat /tmp/clio-workspace/analysis.json)
          
          {
            echo "## Automated Triage Result"
            echo ""
            echo "This issue has been automatically closed."
            echo ""
            echo "**Reason:** ${CLOSE_REASON}"
            echo ""
            echo "$(echo "$ANALYSIS" | jq -r '.summary // "Issue closed by automated triage."')"
            echo ""
            echo "If you believe this is incorrect, please reopen the issue with additional information."
          } > /tmp/clio-workspace/close_comment.md
          
          gh issue comment "$ISSUE_NUMBER" --body-file /tmp/clio-workspace/close_comment.md
          gh issue close "$ISSUE_NUMBER" --reason "not planned" 2>/dev/null || gh issue close "$ISSUE_NUMBER"
      
      - name: Handle needs-info recommendation
        if: steps.parse.outputs.recommendation == 'needs-info'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          ANALYSIS=$(cat /tmp/clio-workspace/analysis.json)
          
          {
            echo "## More Information Needed"
            echo ""
            echo "$(echo "$ANALYSIS" | jq -r '.summary // "More information is needed to process this issue."')"
            echo ""
            echo "**Please provide:**"
            echo "$ANALYSIS" | jq -r '(.missing_info // ["Additional details needed"])[] | "- " + .'
            echo ""
            echo "Once you've added this information, the issue will be re-evaluated."
          } > /tmp/clio-workspace/needs_info_comment.md
          
          gh issue comment "$ISSUE_NUMBER" --body-file /tmp/clio-workspace/needs_info_comment.md
          gh issue edit "$ISSUE_NUMBER" --add-label "needs-info" 2>/dev/null || \
          (gh label create "needs-info" --color "d876e3" --description "Awaiting more information from reporter" 2>/dev/null; gh issue edit "$ISSUE_NUMBER" --add-label "needs-info") || true
      
      - name: Post triage summary
        if: steps.parse.outputs.recommendation == 'ready-for-review'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          ANALYSIS=$(cat /tmp/clio-workspace/analysis.json)
          CLASSIFICATION=$(echo "$ANALYSIS" | jq -r '.classification // "unknown"')
          PRIORITY=$(echo "$ANALYSIS" | jq -r '.priority // "medium"')
          COMPLETENESS=$(echo "$ANALYSIS" | jq -r '.completeness // "N/A"')
          
          {
            echo "## Automated Triage Summary"
            echo ""
            echo "| Field | Value |"
            echo "|-------|-------|"
            echo "| Classification | \`${CLASSIFICATION}\` |"
            echo "| Priority | \`${PRIORITY}\` |"
            echo "| Completeness | ${COMPLETENESS}% |"
            echo ""
            echo "**Analysis:** $(echo "$ANALYSIS" | jq -r '.summary // "Issue triaged successfully."')"
            echo ""
            echo "_This is an automated analysis. A maintainer will review shortly._"
          } > /tmp/clio-workspace/triage_comment.md
          
          gh issue comment "$ISSUE_NUMBER" --body-file /tmp/clio-workspace/triage_comment.md
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: triage-artifacts
          path: |
            /tmp/clio-workspace/full_response.txt
            /tmp/clio-workspace/triage.json
            /tmp/clio-workspace/analysis.json
            /tmp/clio-workspace/ISSUE_INFO.md
            /tmp/clio-workspace/ISSUE_BODY.md
            /tmp/clio-workspace/*.md
          retention-days: 7
