name: Update Cask on Release

on:
  workflow_call:
    inputs:
      project:
        required: true
        type: string
        description: "Project name (sam, etc.)"
      version:
        required: true
        type: string
        description: "Release version tag"
      download_url:
        required: true
        type: string
        description: "URL to DMG file"

jobs:
  update-cask:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout homebrew repo
        uses: actions/checkout@v4
        with:
          repository: SyntheticAutonomicMind/homebrew
          token: ${{ secrets.HOMEBREW_TOKEN }}

      - name: Download DMG and calculate SHA256
        id: hash
        run: |
          curl -L -o /tmp/${{ inputs.project }}.dmg "${{ inputs.download_url }}"
          SHA256=$(shasum -a 256 /tmp/${{ inputs.project }}.dmg | cut -d' ' -f1)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "Calculated SHA256: $SHA256"

      - name: Update cask
        run: |
          PROJECT="${{ inputs.project }}"
          VERSION="${{ inputs.version }}"
          SHA256="${{ steps.hash.outputs.sha256 }}"
          
          # Update the cask file
          sed -i \
            -e "s|version \"[^\"]*\"|version \"$VERSION\"|" \
            -e "s|sha256 \"[^\"]*\"|sha256 \"$SHA256\"|" \
            Casks/$PROJECT.rb
          
          # Verify changes
          echo "Updated Casks/$PROJECT.rb:"
          grep -E "version|sha256" Casks/$PROJECT.rb | head -2

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          PROJECT="${{ inputs.project }}"
          VERSION="${{ inputs.version }}"
          
          git add Casks/$PROJECT.rb
          if git diff --staged --quiet; then
            echo "No changes detected"
          else
            git commit -m "chore($PROJECT): update cask to $VERSION"
            git push
          fi

      - name: Notify completion
        run: |
          echo "[OK] Updated ${{ inputs.project }} cask to ${{ inputs.version }}"
          echo "Cask: Casks/${{ inputs.project }}.rb"
          echo "SHA256: ${{ steps.hash.outputs.sha256 }}"
